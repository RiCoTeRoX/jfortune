(function(e){function d(e,t){return Math.floor(Math.random()*(t-e+1))+e}function v(e){return e==="counterclockwise"?-1:1}function m(i){var s,u;if(!l){l=i}s=(i-l)/o.duration;u=Bezier.cubicBezier(o.bezier.p1x,o.bezier.p1y,o.bezier.p2x,o.bezier.p2y,s);n=u*c;f.rotate(n,r);if(Math.abs(n)<Math.abs(c)){p=requestAnimationFrame(m)}else{t.resolve(e.isArray(o.prices)?o.prices[a]:a)}}function g(){var e=Math.abs((i*.5+n)%i),t=Math.abs(n-u),r=o.separator_thickness*.5,s=i-r;if(t>=i*.5){return 1}else if(e<r||e>s){return 2}return 0}function v(e){return e==="counterclockwise"?-1:1}function y(e){var t=[[Math.cos(e),Math.sin(e),0,0],[Math.sin(-e),Math.cos(e),0,0],[0,0,1,0],[0,0,0,1]],n="";for(var r=0;r<t.length;r++){n+=(r>0?",":"")+t[r].join(",")}return n}var t,n,r,i,s,o,u=0,a,f,l,c,h,p;e.fn.fortune=function(y){if(!y||!y.prices){throw new Error("You must define the prices.")}f=this;o=e.extend({},e.fn.fortune.defaults,y);h=e.isArray(y.prices)?o.prices.length:y.prices;i=360/h;this.spin=function(n,s,f){var g,y,b,w;t=e.Deferred();r=s||o.direction;w=v(r);if(!f){a=typeof n==="number"?n:Math.floor(Math.random()*h);y=d(o.separation,i-o.separation);g=i*((r==="counterclockwise"?h-a:a)-.5)+y;b=d(o.min_spins,o.max_spins);c=w*(360*b+g)}else{a=n;c=w*f}u=l=0;p=requestAnimationFrame(m);return t.promise()};this.rotate=function(t,i){var a=g();r=i;direction_multiplier=v(r);n=t;e.fn.fortune.rotate.call(this,n);if(a){if(a===1||!s){o.onSpinBounce(this)}e.fn.fortune.spinnerBounce.call(this,direction_multiplier);s=true}else{e.fn.fortune.stopSpinnerBounce.call(this);s=false}u=n};this.forceEnd=function(){if(p){cancelAnimationFrame(p)}f.rotate(c,r);e.fn.fortune.stopSpinnerBounce.call(this);if(t){t.resolve(e.isArray(o.prices)?o.prices[a]:a)}};return this};e.fn.fortune.rotate=function(t){var n=y(t*Math.PI/180);e("."+o.wheel_classname,this).css({transform:"matrix3d("+n+")","-webkit-transform":"matrix3d("+n+")"})};e.fn.fortune.spinnerBounce=function(t){var n=y(5*t*Math.PI/180);e("."+o.spinner_classname,this).css({transform:"matrix3d("+n+")","-webkit-transform":"matrix3d("+n+")"})};e.fn.fortune.stopSpinnerBounce=function(){var t=y(0);e("."+o.spinner_classname,this).css({transform:"matrix3d("+t+")","-webkit-transform":"matrix3d("+t+")"})};e.fn.fortune.defaults={duration:1e3,separation:5,min_spins:10,max_spins:15,direction:"clockwise",wheel_classname:"wheel",spinner_classname:"spinner",bezier:{p1x:.17,p1y:.67,p2x:.12,p2y:.99},separator_thickness:7,onSpinBounce:function(){}}})(jQuery)