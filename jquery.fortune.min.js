(function(e){function p(e,t){return Math.floor(Math.random()*(t-e+1))+e}function d(e){return e==="counterclockwise"?-1:1}function v(i){var s,u;if(!l){l=i}s=(i-l)/o.duration;u=Bezier.cubicBezier(o.bezier.p1x,o.bezier.p1y,o.bezier.p2x,o.bezier.p2y,s);n=u*c;f.rotate(n,r);if(Math.abs(n)<Math.abs(c)){requestAnimationFrame(v)}else{t.resolve(e.isArray(o.prices)?o.prices[a]:a)}}function m(){var e=Math.abs((i*.5+n)%i),t=Math.abs(n-u),r=o.separator_thickness*.5,s=i-r;if(t>=i*.5){return 1}else if(e<r||e>s){return 2}return 0}function d(e){return e==="counterclockwise"?-1:1}function g(e){var t=[[Math.cos(e),Math.sin(e),0,0],[Math.sin(-e),Math.cos(e),0,0],[0,0,1,0],[0,0,0,1]],n="";for(var r=0;r<t.length;r++){n+=(r>0?",":"")+t[r].join(",")}return n}var t,n,r,i,s,o,u=0,a,f,l,c,h;e.fn.fortune=function(g){if(!g||!g.prices){throw new Error("You must define the prices.")}f=this;o=e.extend({},e.fn.fortune.defaults,g);h=e.isArray(g.prices)?o.prices.length:g.prices;i=360/h;this.spin=function(n,s){var f,m,g,y;t=e.Deferred();a=typeof n==="number"?n:Math.floor(Math.random()*h);r=s||o.direction;y=d(r);m=p(o.separation,i-o.separation);f=i*((r==="counterclockwise"?h-a:a)-.5)+m;g=p(o.min_spins,o.max_spins);c=y*(360*g+f);u=l=0;requestAnimationFrame(v);return t.promise()};this.rotate=function(t,i){var a=m();e.fn.fortune.rotate.call(this,n);r=i;direction_multiplier=d(r);n=t;if(a){if(a===1||!s){o.onSpinBounce(this)}e.fn.fortune.spinnerBounce.call(this,direction_multiplier);s=true}else{e.fn.fortune.stopSpinnerBounce.call(this);s=false}u=n};return this};e.fn.fortune.rotate=function(t){var n=g(t*Math.PI/180);e("."+o.wheel_classname,this).css({transform:"matrix3d("+n+")","-webkit-transform":"matrix3d("+n+")"})};e.fn.fortune.spinnerBounce=function(t){var n=g(5*t*Math.PI/180);e("."+o.spinner_classname,this).css({transform:"matrix3d("+n+")","-webkit-transform":"matrix3d("+n+")"})};e.fn.fortune.stopSpinnerBounce=function(){var t=g(0);e("."+o.spinner_classname,this).css({transform:"matrix3d("+t+")","-webkit-transform":"matrix3d("+t+")"})};e.fn.fortune.defaults={duration:1e3,separation:5,min_spins:10,max_spins:15,direction:"clockwise",wheel_classname:"wheel",spinner_classname:"spinner",bezier:{p1x:.17,p1y:.67,p2x:.12,p2y:.99},separator_thickness:7,onSpinBounce:function(){}}})(jQuery)